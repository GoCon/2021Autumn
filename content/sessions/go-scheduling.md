---
key: go-scheduling
title: Understanding the Go scheduling - Goにおけるスケジューリングの体系化(仮)
id: go-scheduling
format: conference
talkType: ""
allroom: false
speakers:
- saki_engineer
---
Goにおいて複数のゴールーチンを並行に実行するためのスケジューラは、Goランタイム内で実装されています。しかし現在のスケジューラの大枠が実装されたのは9年前のGo1.1であり、世の中におけるGoのスケジューラ解説はそのときに世に出た公式設計書を元に、視覚的な図ベースで組み立てられているものがほとんどです。本セッションでは、スケジューラの挙動について実際のruntimeパッケージ内のコードベースで理解することを目的に、スケジューラについての説明体系を再構築します。

---

## このセッションで話さないこと
以下のことは今回は話題にはしません。
- 並行処理って何？
- ゴールーチンって何？
- ゴールーチンを使って並行処理をうまく実装するにはどう書いたらいいの？

特に上2つに関しては、今回既知として扱わせていただきます。ご了承ください。

## このセッションで話すこと・聞くとわかるようになること(予定)
- `runtime`パッケージって何やってるの？
- Goのスケジューラってどういう指針でゴールーチンをスケジューリングしているの？
- ゴールーチンのプリエンプトってどうやっているの？
- システムコールを読んだとき・ネットワークI/Oに入ったときに、ランタイムはどういう処理をするの？
- `runtime`・スケジューラの文脈でよく聞くG,M,Pって何？

## 主な対象者
- Goで並行処理を書く人。特に「書いたゴールーチンがうまい具合に全部実行されるようスケジューリングされるのって不思議だな〜」と思っている人。
- Goのスケジューラについて理解したい人。
- システムプログラミングに興味がある人。
- G,M,Pを使ってこれからGoのスケジューリングについて誰かに教えようとしている人。

## 課題と目的
Go言語には並行処理を行うための機構であるゴールーチンが存在し、そしてそれが複数存在する場合に「どのゴールーチンをスレッドに載せて実行させるか」をOSに頼らず決定するスケジューラーをGo独自の仕組みとして持っています。

現在のスケジューラの形が出来上がったのはGo1.1で、その公式設計書 - [Scalable Go Scheduler Design Doc](https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw/edit#) - において「GoのスケジューリングはG(goroutine),M(machine),P(Processor)という3つのリソースをうまく組み合わせることによって行う」という考え方が確立されました。
この設計書を元に[Morsing's Blog: The Go scheduler](https://morsmachine.dk/go-scheduler)のようにG,M,Pの挙動を図にして表し説明する記事が数多く書かれ、様々な場合においてこれら3つの要素がどのような動きをするのかについて盛んに示されるようになりました。

しかし、これらの文脈において語られる概念が全てG,M,Pの中に収まっているのかというと、必ずしもそうではありません。
例えば、実行可能なゴールーチン(G)を保存しておく場所としてランタイム全体の「グローバルキュー」というものが存在しますが、これは`runtime`パッケージ内ではG,M,Pとは別場所で実装されています。

また、[Morsing's Blog: The Go scheduler](https://morsmachine.dk/go-scheduler)の記事を元に、Goのスケジューラの動きについて図を用いて語るウェブ記事やLTが数多く作られてきましたが、そのほとんどが図による説明のみで、それを実装しているコードがどこにあるのかについて示されているものはほとんどありません。

<img src="https://morsmachine.dk/steal.jpg" alt="G,M,Pを用いた一般的な図" width="400" height="300">

本セッションでは、Goのスケジューラを理解するために必要となる概念を**過不足なく**取り上げ、その挙動を`runtime`パッケージ内の**実装コードを明示しながら**紐解いていくことを目的とします。
また、その過程において、Goのスケジューラをより明確に理解するための新しい切り口・体系のあり方について提案したいと思います。