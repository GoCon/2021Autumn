---
key: io-fs-testability
title: io/fsパッケージを用いたテスタブルなコード生成ツールの開発
id: io-fs-testability
format: conference
talkType: ""
allroom: false
speakers:
- tenntenn
---
io/fsパッケージによりOSのファイルシステムに依存しない処理を書けます。例えば、複数のファイルを生成するツールの開発において、生成したファイル群をtxtar形式で出力し、ファイルシステムとして扱うことでテストを容易にできます。また、複数のファイルにまたがるテンプレートをtxtar形式として扱い、それをファイルシステムとして解釈することでtext/templateパッケージでパースでき、保守しやすさと可読性を両立できます。本セッションでは、skeletonという静的解析ツールのコードの雛形を生成するツールの開発で用いているio/fsパッケージを使ったいくつかの手法についてご紹介します。

---

このセッションは以下のような構成で発表する予定です。

* [05min] コード生成とファイルシステムの抽象化
* [15min] 保守しやすいコード生成
* [15min] コード生成とゴールデンファイルテスト
* [05min] まとめ

## [05min] コード生成とファイルシステムの抽象化
[skeleton](https://github.com/gostaticanalysis/skeleton)は静的解析ツールのコードの雛形を生成するコマンドラインツールです。ディレクトリに別れたいくつかのファイルを渡された入力を使って生成します。

現在のskeletonはv2です。v1における開発で直面したコード生成特有の課題とその問題をv2において改善するために用いた手法について概要を説明します。

## [15min] 保守しやすいコード生成

skeletonのv1では自作ツールを使ってあるディレクトリ以下を[txtar](https://golang.org/x/tools/txtar)形式に変換し、それをtext/templateパッケージを用いてテンプレートとしてパースしていました。テンプレートに入力されたデータを展開し、その結果を再度txtar形式として解釈し、ディレクトリやファイルを生成していました。

v2では、embedパッケージを用いてあるディレクトリ以下をファイルシステム（embed.FS）としてパッケージ変数に埋め込み、それをtxtar形式（[txtarfs](https://pkg.go.dev/github.com/josharian/txtarfs)）として解釈しています。

ここでは、Goのコンパイラで用いられているtxtar形式やembedパッケージ、io/fsパッケージ、txtar形式にfs.FSインタフェースを実装させるtxtarfsパッケージなどの説明をv1とv2のコードを比較しながら説明します。

go.modファイルをembedパッケージで埋め込むちょっとしたTIPSなども紹介する予定です。
また、小さなコードを使ったデモも考えています。

## [15min] コード生成とゴールデンファイルテスト

v1ではテストが全くありませんでした。コマンドライン引数やオプションによって生成されるファイルが変わり、テストがしづらいことも理由の1つでした。

そこで、v2ではtxtarfsパッケージとゴールデンファイルテストを組み合わせることでコード生成と相性のよいテスト手法を編み出しました。

ここでは、コード生成ツールのテストのしづらさやゴールデンファイルテスト、txtarfsパッケージを使ったテストについて説明します。

ここでも小さなコードを使ったデモも考えています。

## [05min] まとめ

セッションをまとめます。
今後の展望なども話せるといいかなと思ってます。